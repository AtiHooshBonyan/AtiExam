@model AtiExamSite.Models.DomainModels.Question

@{
    ViewData["Title"] = "Question Details";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-start mb-3 flex-wrap gap-2">
        <div>
            <h1 class="mb-1">Question Details</h1>
            <small class="text-muted">ID: @Model.Id</small>
        </div>
        <div class="btn-group">
            <a asp-action="AddOptions" asp-route-questionId="@Model.Id" class="btn btn-sm btn-success">
                <i class="fas fa-plus-circle me-1"></i> Add Options
            </a>
            <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-sm btn-warning">
                <i class="fas fa-edit me-1"></i> Edit
            </a>
            <a asp-action="Index" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to List
            </a>
        </div>
    </div>

    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h2 class="mb-0">Metadata</h2>
        </div>
        <div class="card-body">
            <dl class="row mb-0">
                <dt class="col-sm-3">Title:</dt>
                <dd class="col-sm-9">@Model.Title</dd>

                <dt class="col-sm-3">Difficulty:</dt>
                <dd class="col-sm-9">
                    <span class="badge @GetDifficultyBadgeClass(Model.DifficultyLevel)">
                        @Model.DifficultyLevel
                    </span>
                </dd>

                <dt class="col-sm-3">Total Options:</dt>
                <dd class="col-sm-9">@((Model.QuestionOptions?.Count) ?? 0)</dd>
            </dl>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
            <div>
                <h3 class="mb-0">Options</h3>
                <small class="text-light">(@(Model.QuestionOptions?.Count ?? 0))</small>
            </div>
            @if (Model.QuestionOptions != null && Model.QuestionOptions.Any())
            {
                <form asp-action="RemoveOptions" method="post" id="removeOptionsForm" class="mb-0 d-flex gap-2">
                    <input type="hidden" name="questionId" value="@Model.Id" />
                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to remove selected options?');" disabled id="removeSelectedBtn">
                        <i class="fas fa-trash me-1"></i> Remove Selected
                    </button>
                </form>
            }
        </div>
        <div class="card-body">
            @if (Model.QuestionOptions?.Any() == true)
            {
                <form asp-action="RemoveOptions" method="post" id="optionsTableForm">
                    <input type="hidden" name="questionId" value="@Model.Id" />
                    <div class="table-responsive">
                        <table class="table table-bordered align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width:1%">
                                        <input type="checkbox" id="selectAll" aria-label="Select all options" />
                                    </th>
                                    <th>Option</th>
                                    <th class="text-center">Correct</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var qo in Model.QuestionOptions)
                                {
                                    var option = qo.Option;
                                    bool isCorrect = option?.IsCorrect == true;
                                    <tr>
                                        <td>
                                            <input class="form-check-input option-checkbox" type="checkbox" name="optionIds" value="@qo.OptionId" />
                                        </td>
                                        <td>
                                            @option?.Title
                                        </td>
                                        <td class="text-center">
                                            @if (isCorrect)
                                            {
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check-circle me-1"></i>Correct
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">Incorrect</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-2 d-flex gap-2">
                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Remove selected options?');" id="removeBtn" disabled>
                            <i class="fas fa-trash-alt me-1"></i> Remove Selected
                        </button>
                    </div>
                </form>
            }
            else
            {
                <div class="alert alert-info">No options assigned to this question.</div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const selectAll = $('#selectAll');
            const checkboxes = $('.option-checkbox');
            const removeBtn = $('#removeBtn');
            const removeSelectedBtn = $('#removeSelectedBtn');

            function updateButtons() {
                const anyChecked = $('.option-checkbox:checked').length > 0;
                removeBtn.prop('disabled', !anyChecked);
                removeSelectedBtn?.prop('disabled', !anyChecked);
                selectAll.prop('checked', $('.option-checkbox').length === $('.option-checkbox:checked').length);
            }

            selectAll.on('change', function () {
                $('.option-checkbox').prop('checked', $(this).is(':checked'));
                updateButtons();
            });

            $(document).on('change', '.option-checkbox', updateButtons);
        })();
    </script>
}

@functions {
    public string GetDifficultyBadgeClass(string difficulty)
    {
        return difficulty switch
        {
            "Easy" => "bg-success",
            "Medium" => "bg-warning text-dark",
            "Hard" => "bg-danger",
            _ => "bg-secondary"
        };
    }
}
